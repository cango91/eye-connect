<%- include('../partials/header') %>
<%- include('../partials/navigation') %>
<main class="container-xl mt-5 py-4 bg-light shadow-lg rounded">
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Are you sure you want to deletet this exam?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Confirming this action will permanently delete the exam.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="confirmBackModal" tabindex="-1" aria-labelledby="confirmBackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmBackModalLabel">Changes will be lost</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          You have unsaved changes, navigating away from this page without saving them will loose these changes permanently. Are you sure you want to continue?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmBackBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center">
    <h3><span class="float-start"><a id="confirm-back-btn" class="btn btn-secondary" href="/portal/exams">&larr; All Exams</a></span>Exam Details<span class="float-end" id="icons-area"><a class="btn btn-success ms-1" id="save-btn"><%- saveIcon %></a><a class="btn btn-danger ms-1" id="delete-btn" data-bs-toggle="modal" data-bs-target="#deleteModal"><%- deleteIcon %></a></span></h3>
    <hr>
  </div>
  <div class="d-flex flex-column justify-content-center align-items-center" id="loading-div">
    <h2 class="text-info">Loading exam</h2>
    <div><strong>Please wait...</strong></div>
    <div class="spinner-border mt-2 text-warning" role="status">
    </div>
  </div>
  <div id="main-div">
    <div class="container-lg">
      <div class="alert alert-danger d-none"></div>
      <div class="alert" id="alert-div"></div>
      <div class="text-start">
        <h5><span id="examiner-name"></span></h5>
      </div>
      <div class="row">
        <div class="col-md-6 order-md-2 order-lg-1">
          <span class="text-muted">Notes</span>
          <h4 class="d-flex justify-content-between align-items-center mb-3">
          </h4>
          <textarea class="form-control" id="exam-notes" rows="15"></textarea>
        </div>
        <div class="col-md-6 order-md-1 order-lg-2">
          <h4 class="mb-3">Patient Info</h4>
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <small>Name:</small>
              <span id="patient-name"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <small>Sex:</small>
              <span id="patient-gender"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <small>Age:</small>
              <span id="patient-age"></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <small>Date of Birth:</small>
              <span id="dob" class="badge text-dark"></span>
            </li>
          </ul>
          <div id="upload-area">
            <h4 class="mb-3">Image Upload</h4>
            <form>
              <div class="form-group">
                <ul class="list-group mb-3">
                  <li class="list-group-item d-flex justify-content-between">
                    <span id="existing-label"></span>
                    <span id="existing-count"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between"><button class="input-group-text" id="choose-files">Choose Files</button><input type="file" id="examImageUpload" multiple><span id="session-images"></span><span class="btn btn-success ms-1 d-none" id="upload-all-btn"><%- uploadAllIcon %></span><span id="remove-all-btn" class="btn btn-danger ms-1 d-none"><%- removeAllIcon %></span></li>
                </ul>
              </div>
              <div class="drag-drop-area border p-3 mt-3">
                <h5>Drag & Drop Images Here</h5>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="d-flex flex-nowrap overflow-auto mt-3" id="image-container"></div>
      </div>
    </div>
  </div>
</main>
<script>
  const mainEl = document.getElementById('main-div');
  const loadingEl = document.getElementById('loading-div');
  const alertDiv = document.querySelector('.alert');
  const dropArea = document.querySelector('.drag-drop-area');
  const notesEl = document.getElementById('exam-notes'); // should have `disabled` in view mode.
  const dobEl = document.getElementById('dob');
  const ageEl = document.getElementById('patient-age');
  const genderEl = document.getElementById('patient-gender');
  const patientNameEl = document.getElementById('patient-name');
  const examinerNameEl = document.getElementById('examiner-name'); // displayed only in view mode.
  const uploadEl = document.getElementById('examImageUpload');
  const uploadArea = document.getElementById('upload-area');
  const saveBtn = document.getElementById('save-btn');
  const deleteBtn = document.getElementById('delete-btn');
  const iconsArea = document.getElementById('icons-area');
  const imageContainer = document.getElementById('image-container');
  const sessionImagesEl = document.getElementById('session-images');
  const existingCountEl = document.getElementById('existing-count');
  const existingLabelEl = document.getElementById('existing-label');
  const chooseFilesBtn = document.getElementById('choose-files');
  const uploadAllBtn = document.getElementById('upload-all-btn');
  const removeAllBtn = document.getElementById('remove-all-btn');
  const backBtn = document.getElementById('confirm-back-btn');
  const confirmBack = document.getElementById('confirmBackBtn');
  const magnifySvg = `<%- magnifyIcon %>`;

  const imagesArray = [];

  const ICON_DIMS = [25, 25];


  let myExam;
  let notesCache;
  let examinerId;
  let patientId;
  let existingImages;
  let sessionImages;

  const showLoading = () => {
    mainEl.classList.add('d-none');
    loadingEl.classList.remove('d-none');
  }

  const hideLoading = () => {
    mainEl.classList.remove('d-none');
    loadingEl.classList.add('d-none');
  }

  const reportError = err => {
    alertDiv.classList.remove('d-none');
    alertDiv.innerHTML = `Could not create exam<br>Reason: ${err}`;
  }

  const fetchImages = async imageIds => {
    const images = [];
    for (let id of imageIds) {
      const response = await fetch(`/portal/api/funduscopies/${id}`);
      const imageData = await response.json();
      if (!imageData.error) {
        images.push(imageData.data);
      } else {
        console.error('Error fetching image:', imageData.error);
        reportError(imageData.error);
      }
    }
    return images;
  }

  const backCheck = () => {

    if (myExam && (notesCache !== notesEl.value || sessionImages)) {
      const modal = new bootstrap.Modal(document.getElementById('confirmBackModal'));
      modal.show();
    } else {
      simulateClick(confirmBack);
    }
  }

  const saveNotes = async () => {
    const tempCache = notesEl.value;
    const params = new URLSearchParams();
    params.append('notes', tempCache.toString());
    try {
      const response = await fetch(`/portal/api/examinations/<%= examId %>?_method=put`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params.toString()
      });
      if (!response.ok) {
        const errorMessage = await response.text();
        console.error(`Request failed with status ${response.status}: ${errorMessage}`);
        showAlert(`Notes update failed<br>Reason:${errorMessage}`, 'danger');
        return;
      }
      try {
        data = await response.json();
        if (!data.error) {
          showAlert('Notes Updated', 'success');
          notesCache = tempCache;
          saveEnabler({
            target: {
              value: tempCache
            }
          });
        } else {
          console.error(data);
          showAlert(`Notes update failed<br>Reason: ${data}`, 'danger');
        }
      } catch (error) {
        console.error(response);
        showAlert(`Notes update failed<br>Reason: ${await response.text()}`, 'danger');
      }
    } catch (err) {
      console.error(err);
      showAlert(`Notes update failed<br>Reason: ${err}`, 'danger');
    }
  }

  const disableEditing = () => {
    notesEl.disabled = true;
    uploadArea.classList.add('d-none');
    iconsArea.classList.add('d-none');
    notesEl.rows = 6;
  }

  const enableEditing = () => {
    notesEl.disabled = false;
    uploadArea.classList.remove('d-none');
    iconsArea.classList.remove('d-none');
    notesEl.rows = 15;
  }



  const handleExamData = async data => {
    if (data.notes) notesEl.textContent = data.notes;
    examinerId = data.examiner._id
    myExam = examinerId === '<%= user.id %>';
    if (myExam) {
      document.querySelector('.nav-link.active').innerText = 'Update Exam'
    }
    patientId = data.patient._id;
    patientName = data.patient.name;
    examinerNameEl.innerHTML = `<b>Examiner:</b> Dr. ${data.examiner.name}`;
    patientNameEl.textContent = data.patient.name;
    dobEl.textContent = getDate(data.patient.dateOfBirth);
    ageEl.textContent = calculateAge(data.patient.dateOfBirth);
    genderEl.textContent = data.patient.gender;

    if (!myExam) {
      disableEditing();
    } else {
      notesCache = data.notes ? data.notes : '';
      saveBtn.classList.add('disabled');
    }
    hideLoading();

    if (data.images && data.images.length) {
      const images = await fetchImages(data.images);
      imagesArray.concat(images);
      displayImages(images);
    }
  }

  const fetchExamData = () => {
    fetch(`/portal/api/examinations/<%= examId %>`)
      .then(response => response.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        handleExamData(data.data);
      })
      .catch(error => reportError(error));
  }

  //   const displayImages = (images) => {
  //     while (imageContainer.firstChild) {
  //       imageContainer.removeChild(imageContainer.firstChild);
  //     }
  //     images.forEach((image, index) => {
  //       const imageDiv = document.createElement('div');
  //       imageDiv.id = `image-${index}`;
  //       imageDiv.classList.add('image-thumbnail');

  //       const img = document.createElement('img');
  //       img.src = URL.createObjectURL(new Blob([image.data], {
  //         type: image.contentType
  //       }));
  //       img.alt = 'Retina Image';

  //       imageDiv.appendChild(img);
  //       imageContainer.appendChild(imageDiv);
  //     });
  //   };


  const createAndStyleIcon = (dimensions, innerSvg, ...btnClasses) => {
    const span = document.createElement('span');
    span.className = btnClasses.join(' ');
    const icon = document.createElement('span');
    icon.innerHTML = innerSvg;
    const svg = icon.querySelector('svg');
    svg.style.width = dimensions[0];
    svg.style.width = dimensions[1];
    span.appendChild(icon);
    span.style.zIndex = 1;
    return span;
  }

  const bufferToB64 = (bufferArray, contentType) => {
    const uint8Array = new Uint8Array(bufferArray);
    const blob = new Blob([uint8Array], {
      type: contentType
    });
    const reader = new FileReader();

    return new Promise((resolve, reject) => {
      reader.onloadend = () => {
        resolve(reader.result);
      };

      reader.onerror = () => {
        reject(new Error('Error occurred while reading the buffer.'));
      };

      reader.readAsDataURL(blob);
    });
  }

  const displayImages = (images) => {
    for (let i = 0; i < images.length; i++) {
      let img = document.createElement('img');
      if (images[i].image && images[i].image.data && images[i].image.data.data && images[i].image.contentType) {
        bufferToB64(images[i].image.data.data, images[i].image.contentType).then((src) => {
          img.src = src;
        });
      } else {
        img.src = images[i];
      }
      img.className = 'img-thumbnail';

      const magnifyIcon = createAndStyleIcon(ICON_DIMS, `<%- magnifyIcon %>`, 'btn', 'border', 'border-dark', 'border-2', 'btn-warning', 'm-1');
      magnifyIcon.role = "enlarge preview";

      const thumbnailContainer = document.createElement('div');
      thumbnailContainer.className = 'position-relative d-flex';

      let container = document.createElement('div');
      container.className = 'position-absolute d-flex flex-column justify-content-start';
      container.appendChild(magnifyIcon);

      thumbnailContainer.appendChild(img);
      thumbnailContainer.appendChild(container);
      imageContainer.appendChild(thumbnailContainer);
    }
  }

  const previewFile = (file) => {
    let reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = () => {
      let img = document.createElement('img');
      img.src = reader.result;
      img.className = 'img-thumbnail';
      const dims = ICON_DIMS;

      const thumbnailContainer = document.createElement('div');
      thumbnailContainer.className = 'position-relative d-flex';

      thumbnailContainer.dataset.imageContainer = true;

      const magnifyIcon = createAndStyleIcon(dims, `<%- magnifyIcon %>`, 'btn', 'border', 'border-dark', 'border-2', 'btn-warning', 'm-1');

      const removeIcon = createAndStyleIcon(dims, `<%- deleteIcon %>`, 'btn', 'border', 'border-dark', 'border-2', 'btn-danger', 'm-1');
      removeIcon.addEventListener('click', e => {
        removePreview(removeIcon);
      });

      const uploadIcon = createAndStyleIcon(dims, `<%- uploadSingleIcon %>`, 'btn', 'border', 'border-dark', 'border-2', 'btn-success', 'm-1');
      uploadIcon.addEventListener('click', async () => await uploadFile(img));

      magnifyIcon.role = "enlarge preview";
      removeIcon.role = "remove image";
      removeIcon.ariaRoleDescription = 'remove a single image from upload list'
      uploadIcon.role = "upload image";
      uploadIcon.ariaRoleDescription = 'upload a single image'


      let container = document.createElement('div');
      container.className = 'position-absolute d-flex flex-column justify-content-start';
      container.appendChild(magnifyIcon);
      container.appendChild(uploadIcon);
      container.appendChild(removeIcon);

      thumbnailContainer.appendChild(img);
      thumbnailContainer.appendChild(container);
      imageContainer.prepend(thumbnailContainer);
    }
  }

  const uploadAllSession = () => {
    Array.from(document.querySelectorAll('[role="upload image"]')).forEach(btn => simulateClick(btn));
  }

  const removeAllSession = () => {
    Array.from(document.querySelectorAll('[role="remove image"]')).forEach(btn => simulateClick(btn));
  }

  const removePreview = (target) => {
    let parent;
    if (!target.dataset.imageContainer) {
      parent = target.parentNode;
      while (parent) {
        if (parent.dataset.imageContainer) {
          break;
        }
        parent = parent.parentNode;
      }
    } else {
      parent = target;
    }
    parent.remove();
    sessionImages--;
    updateSessionImages();
  }

  const uploadFile = async target => {
    const formData = new FormData();
    try {
      const fileAsDataUrl = target.src;
      // since we read the files as dataUrl and used this to populate preview img src's, we need to convert them to the proper format the backend expects.
      const base64data = fileAsDataUrl.split(',')[1];
      const decodedData = atob(base64data);
      const contentType = fileAsDataUrl.split(':')[1].split(';')[0];
      const arrayBuffer = decodedData.split('').reduce((acc, el, idx) => (acc[idx] = el.charCodeAt(0), acc), new Uint8Array(decodedData.length));
      const blob = new Blob([arrayBuffer], {
        type: contentType
      });
      formData.append('image', blob);
      formData.append('examId', `<%- examId %>`);

      // before we send our request let's add an indication this file is being uploaded
      const btns = target.parentNode.querySelectorAll('.btn');
      Array.from(btns).forEach(btn => btn.classList.add('disabled'));

      const spinner = document.createElement('div');
      spinner.className = 'spinner-border text-danger position-absolute';
      spinner.style.zIndex = 3;
      spinner.style.top = "50%";
      spinner.style.left = "50%";

      target.parentNode.appendChild(spinner);

      const response = await fetch('/portal/api/funduscopies', {
        method: 'POST',
        body: formData
      });
      if (response.ok) {
        displayImages([target.src]);
        removePreview(target);
      } else {
        showAlert(`Couldn't upload imag<br>${await response.text()}`);
      }
    } catch (error) {
      console.log(error);
      showAlert(`Couldn't upload imag<br>${error}`);
    }
  }

  const deleteExam = async () => {
    const response = await fetch(`/portal/api/examinations/<%= examId %>?_method=delete`, {
      method: 'post'
    });
    if (response.status === 200) {
      window.location.href = '/portal/patients';
    } else {
      showAlert(`Couldn't delete exam`, 'danger');
    }
  }

  const handleFiles = files => {
    ([...files]).forEach(previewFile);
    updateSessionImages();
  };
  const preventDefaults = e => {
    e.preventDefault();
    e.stopPropagation();
  }
  const handleDrop = e => {
    sessionImages = sessionImages || 0;
    const dt = e.dataTransfer;
    const data = dt.items;
    const files = [];
    for (let i = 0; i < data.length; i++) {
      if (data[i].kind === 'file' && data[i].type.match("^image/")) {
        sessionImages++;
        files.push(data[i].getAsFile());
      }
    }
    handleFiles(files);
  }

  const highlight = e => {
    dropArea.classList.add('highlight');
  }

  const unhighlight = e => {
    dropArea.classList.remove('highlight');
  }

  const updateSessionImages = () => {
    sessionImages = sessionImages || 0;
    if (sessionImages) {
      [uploadAllBtn, removeAllBtn].forEach(e => e.classList.remove('d-none'));
      sessionImagesEl.innerText = `${sessionImages} images will be uploaded`;
    } else {
      [uploadAllBtn, removeAllBtn].forEach(e => e.classList.add('d-none'));
      sessionImagesEl.innerText = '';
    }
  };

  const updateExistingImages = async () => {
    // TODO fetch total image count (with image refs) for patient (when route exists)

  }

  dropArea.addEventListener('drop', handleDrop);

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults)
    document.body.addEventListener(eventName, preventDefaults)
  });



  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight);

  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight)
  });

  const saveEnabler = e => {
    if (myExam && e.target.value !== notesCache) {
      saveBtn.classList.remove('disabled');
    } else if (myExam && e.target.value === notesCache) {
      saveBtn.classList.add('disabled');
    }
  }

  const showAlert = (message, type) => {
    const alertDiv = document.getElementById('alert-div');
    alertDiv.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message +
      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
  }
  const simulateClick = target => {
    const evt = new MouseEvent('click', {
      view: window,
      bubbles: true,
      cancelable: true
    });
    return target.dispatchEvent(evt);
  }
  // ensure dom is loaded so all our references are available
  window.addEventListener('DOMContentLoaded', async (e) => {
    showLoading();
    await fetchExamData();
    notesEl.addEventListener('input', saveEnabler);
    saveBtn.addEventListener('click', saveNotes);
    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      await deleteExam();
    });
    confirmBack.addEventListener('click', (e) => window.location.href = backBtn.href);
    chooseFilesBtn.addEventListener('click', e => {
      e.preventDefault();
      simulateClick(examImageUpload);
    });
    backBtn.addEventListener('click', e => {
      e.preventDefault();
      backCheck();
    });

    examImageUpload.addEventListener('change', (e) => {
      sessionImages = sessionImages || 0;
      const newImages = Array.from(e.target.files);
      sessionImages += newImages.length;
      handleFiles(newImages);
      e.target.value = null;
    });

    uploadAllBtn.addEventListener('click', uploadAllSession);
    removeAllBtn.addEventListener('click', removeAllSession);


  });
</script>
<%- include('../partials/footer') %>